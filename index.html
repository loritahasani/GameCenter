<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Game Center - Hyrje dhe Regjistrim</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<section id="login-section">
    <h2>Hyr në llogarinë tënde</h2>
    <form id="login-form">
        <label for="login-email">Email:</label>
        <input type="email" id="login-email" required />

        <label for="login-password">Fjalëkalimi:</label>
        <input type="password" id="login-password" required minlength="6" />

        <button type="submit">Hyr</button>
    </form>
    <p>Nuk ke një llogari? <a href="#" id="show-signup">Regjistrohu</a></p>
</section>

<section id="signup-section" style="display:none;">
    <h2>Krijo një llogari</h2>
    <form id="signup-form">
        <label for="signup-name">Emri:</label>
        <input type="text" id="signup-name" required />

        <label for="signup-email">Email:</label>
        <input type="email" id="signup-email" required />

        <label for="signup-password">Fjalëkalimi:</label>
        <input type="password" id="signup-password" required minlength="6" />

        <label for="confirm-password">Konfirmo Fjalëkalimin:</label>
        <input type="password" id="confirm-password" required minlength="6" />

        <label>Zgjedh rolin:</label>
        <div class="role-selection">
            <input type="radio" id="student" name="role" value="student" checked />
            <label for="student">Student</label>

            <input type="radio" id="teacher-role" name="role" value="teacher" />
            <label for="teacher-role">Mësues</label>
        </div>

        <label for="school">Shkolla:</label>
        <select id="school" name="school" required>
            <option value="" selected disabled>Zgjedh shkollën</option>
        </select>

        <div id="student-fields">
            <label for="teacher">Mësuesi:</label>
            <select id="teacher" name="teacher" required>
                <option value="" selected disabled>Zgjedh mësuesin</option>
            </select>
        </div>

        <button type="submit">Regjistrohu</button>
    </form>
    <p>Ke tashmë një llogari? <a href="#" id="show-login">Hyr</a></p>
</section>

<script>
// Switch login/signup forms
document.getElementById("show-signup").addEventListener("click", e => {
    e.preventDefault();
    document.getElementById("login-section").style.display = "none";
    document.getElementById("signup-section").style.display = "block";
});

document.getElementById("show-login").addEventListener("click", e => {
    e.preventDefault();
    document.getElementById("signup-section").style.display = "none";
    document.getElementById("login-section").style.display = "block";
});

// Show/hide teacher select for students
document.querySelectorAll('input[name="role"]').forEach(radio => {
    radio.addEventListener("change", function () {
        const studentFields = document.getElementById("student-fields");
        if (this.value === "student") {
            studentFields.style.display = "block";
            document.getElementById("teacher").required = true;
        } else {
            studentFields.style.display = "none";
            document.getElementById("teacher").required = false;
        }
    });
});

// Load schools on page load
window.addEventListener("DOMContentLoaded", async () => {
    const schoolSelect = document.getElementById("school");
    try {
        const response = await fetch("http://localhost:5000/schools");
        const schools = await response.json();
        schools.forEach(school => {
            const option = document.createElement("option");
            option.value = school;
            option.textContent = school;
            schoolSelect.appendChild(option);
        });
    } catch (err) {
        console.error("Gabim në ngarkimin e shkollave", err);
    }
});

// Load teachers when school is selected
document.getElementById("school").addEventListener("change", async function () {
    const school = this.value;
    const teacherSelect = document.getElementById("teacher");
    teacherSelect.innerHTML = '<option value="" selected disabled>Zgjedh mësuesin</option>';
    if (!school) return;

    try {
        const response = await fetch(`http://localhost:5000/teachers/${encodeURIComponent(school)}`);
        if (!response.ok) throw new Error("Gabim në marrjen e mësuesve");
        const data = await response.json();

        data.teachers.forEach(teacher => {
            const option = document.createElement("option");
            option.value = teacher._id;
            option.textContent = teacher.name;
            teacherSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Gabim gjatë marrjes së mësuesve:", error);
    }
});

// Signup form submit
document.getElementById("signup-form").addEventListener("submit", async e => {
    e.preventDefault();

    const name = document.getElementById("signup-name").value.trim();
    const email = document.getElementById("signup-email").value.trim();
    const password = document.getElementById("signup-password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const role = document.querySelector('input[name="role"]:checked').value;
    const school = document.getElementById("school").value;
    let teacher = "";

    if (password !== confirmPassword) {
        alert("Fjalëkalimet nuk përputhen!");
        return;
    }

    if (role === "student") {
        teacher = document.getElementById("teacher").value;
        if (!teacher) {
            alert("Zgjidh një mësues për studentin");
            return;
        }
    }

    if (!school) {
        alert("Zgjidh shkollën");
        return;
    }

    const bodyData = {
        name,
        email,
        password,
        role
    };

    if (role === "teacher") {
        bodyData.school = school;
    } else {
        bodyData.teacher_id = teacher;
    }

    try {
        const response = await fetch("http://localhost:5000/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(bodyData)
        });

        const result = await response.json();
        if (response.ok) {
            alert("Regjistrimi u krye me sukses!");
            document.getElementById("signup-form").reset();
            document.getElementById("signup-section").style.display = "none";
            document.getElementById("login-section").style.display = "block";
        } else {
            alert(result.error || "Gabim gjatë regjistrimit!");
        }
    } catch (error) {
        console.error("Gabim gjatë regjistrimit!", error);
        alert("Gabim në server. Kontrollo lidhjen.");
    }
});

// Login form submit
document.getElementById("login-form").addEventListener("submit", async e => {
    e.preventDefault();

    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value;

    try {
        const response = await fetch("http://localhost:5000/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
        });

        const result = await response.json();
        if (response.ok) {
            localStorage.setItem("token", result.token);
            localStorage.setItem("userName", result.name);
            localStorage.setItem("role", result.role);

            if (result.role === "student") {
                window.location.href = "dashboard.html";
            } else if (result.role === "teacher") {
                window.location.href = "teachers.html";
            }
        } else {
            alert(result.error || "Email ose fjalëkalim i pasaktë!");
        }
    } catch (error) {
        console.error("Gabim gjatë kyçjes!", error);
        alert("Gabim në server. Kontrollo lidhjen.");
    }
});
</script>

</body>
</html>
